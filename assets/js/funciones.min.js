let features={},dataLayers=[];function createGeoJSONCircle(e,a,t){t||(t=64);for(var i,r,o,n=e[1],s=e[0],l=a,c=[],p=l/(111.32*Math.cos(n*Math.PI/180)),d=l/110.574,u=0;u<t;u++)i=u/t*(2*Math.PI),r=p*Math.cos(i),o=d*Math.sin(i),c.push([s+r,n+o]);return c.push(c[0]),{type:"geojson",data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Polygon",coordinates:[c]}}]}}}function createCircleLayer(e,a,t,i,r,o){map.addSource("polygon",createGeoJSONCircle(e,a,t)),map.addLayer({id:"polygon",type:"fill",source:"polygon",layout:{},paint:{"fill-color":i,"fill-opacity":r,"fill-outline-color":"gray"}},o)}function dataFilter(){fetch("map/capas/eclipse-solar-2020-umbra.geojson").then((function(e){return e.text()})).then((function(e){JSON.parse(e).features.forEach(e=>{features[e.properties.hora]={coords:e.geometry.coordinates,properties:e.properties}}),bindButtons(),filterBy(50)})).catch((function(e){}))}horas=["Inicio","14:34","14:36","14:38","14:40","14:42","14:44","14:46","14:48","14:50","14:52","14:54","14:56","14:58","15:00","15:02","15:04","15:06","15:08","15:10","15:12","15:14","15:16","15:18","15:20","15:22","15:24","15:26","15:28","15:30","15:32","15:34","15:36","15:38","15:40","15:42","15:44","15:46","15:48","15:50","15:52","15:54","15:56","15:58","16:00","16:02","16:04","16:06","16:08","16:10","16:12","16:14","16:16","16:18","16:20","16:22","16:24","16:26","16:28","16:30","16:32","16:34","16:36","16:38","16:40","16:42","16:44","16:46","16:48","16:50","16:52","16:54","16:56","16:58","17:00","17:02","17:04","17:06","17:08","17:10","17:12","17:14","17:16","17:18","17:20","17:22","17:24","17:26","17:28","17:30","17:32","17:34","17:36","17:38","17:40","17:42","17:44","17:46","17:48","17:50","17:52","17:54","Fin"];var filterBy=function(e){let a=["==","hora",horas[e]],t=map.getZoom(),i=features[horas[e]].coords,r=parseInt(features[horas[e]].properties.ancho,10)/2;map.getSource("polygon")?map.getSource("polygon").setData(createGeoJSONCircle(i,r).data):(createCircleLayer(i,r,64,"#000000",.7,"umbra"),dataLayers.push("polygon")),map.setFilter("umbra",a),map.flyTo({center:i,zoom:t});let o=document.getElementById("hora"),n=horas[e].split(":");if(isNaN(n[0]))o.textContent=horas[e];else{let a,t=new Date,i=t.getTimezoneOffset()/60,r=horas[e]+" (UTC)",s=n[0]-i+":"+n[1],l=t.toLocaleDateString(void 0,{timeZoneName:"long"}),c=l.substr(l.search(" "));switch(Math.sign(i)){case 1:a=` (-${i} ${c})`;break;case-1:a=` (+${-1*i} ${c})`;break;default:a="";break}o.textContent=s+(a+" || ")+r}document.getElementById("slider").value=e};function move(e){let a=document.getElementById("slider"),t=parseInt(a.value,10),i=parseInt(a.max,10),r=parseInt(a.min,10);switch(e){case"forward":t<i&&filterBy(t+1);break;case"backward":t>r&&filterBy(t-1);break;case"start":filterBy(r);break;case"end":filterBy(i);break;default:break}}function bindButtons(){let e=e=>document.getElementsByName(e)[0];e("start").addEventListener("click",(function(){move("start")})),e("back").addEventListener("click",(function(){move("backward")})),e("next").addEventListener("click",(function(){move("forward")})),e("end").addEventListener("click",(function(){move("end")}))}function opacidad(e){for(var a=map.style._order,t=a.length-1;t>=0;t--)"fill"==map.getLayer(a[t]).type&&dataLayers.indexOf(a[t])<0&&map.setPaintProperty(a[t],"fill-opacity",e)}function ocultarPanel(){$("#panel").toggleClass("oculto")}$(document).ready((function(){function e(e){for(var a=map.style._order,t=a.length-1;t>=0;t--)"satelite"!=a[t]&&"natural_earth"!=a[t]&&"building-3d"!=a[t]?map.setLayoutProperty(a[t],"visibility",e):"none"==map.getLayoutProperty("satelite","visibility")&&map.setLayoutProperty("satelite","visibility","visible")}function a(){dataFilter(),map.addSource("penumbra",{type:"geojson",data:"map/capas/eclipse-solar-2020-penumbra.geojson",attribution:"<a href='https://es.wikipedia.org/wiki/Eclipse_solar_del_14_de_diciembre_de_2020' target='_blank'>Wikipedia</a>"}),map.addSource("umbra",{type:"geojson",data:"map/capas/eclipse-solar-2020-umbra.geojson",attribution:"<a href='https://moonblink.info/Eclipse/eclipse/2020_12_14' target='_blank'>© Moonblink by Ian Cameron Smith</a>"}),map.addLayer({id:"penumbra",type:"fill",source:"penumbra",paint:{"fill-color":"#000000","fill-opacity":.05}}),map.hasImage("eclipse")||map.loadImage("assets/img/eclipse_chico.png",(function(e,a){if(e)throw e;map.addImage("eclipse",a)})),map.addLayer({id:"umbra",type:"symbol",source:"umbra",layout:{"icon-image":"eclipse","icon-size":.35}}),dataLayers.push("umbra"),dataLayers.push("penumbra"),document.getElementById("slider").addEventListener("input",(function(e){var a=parseInt(e.target.value,10);filterBy(a)}))}var t;$("#osm").click((function(a){1==$(this).is(":checked")?e("visible"):e("none")})),$("#satelite").click((function(e){1==$(this).is(":checked")?(map.setLayoutProperty("satelite","visibility","visible"),opacidad(.1),map.setLayoutProperty("background","visibility","none")):(map.setLayoutProperty("satelite","visibility","none"),opacidad(1))})),$("#eclipse-solar").click((function(e){let t=document.getElementsByClassName("map-overlay")[0];1==$(this).is(":checked")?(a(),t.setAttribute("style","visibility: true")):(map.removeLayer("penumbra"),map.removeLayer("umbra"),map.removeSource("penumbra"),map.removeSource("umbra"),t.setAttribute("style","visibility: hidden"))})),$("#chk_sup_calles").click((function(e){1==$(this).is(":checked")?(map.addLayer({id:"sup-calles-unpaved",source:"openmaptiles","source-layer":"transportation",type:"line",minzoom:12,filter:["all",["==","$type","LineString"],["in","class","motorway","trunk","primary","secondary","tertiary","minor","service","track","path","raceway","transit"],["==","surface","unpaved"]],layout:{"line-cap":"round","line-join":"round",visibility:"visible"},paint:{"line-color":"#e87400","line-width":{base:1.55,stops:[[4,.25],[20,30]]}}}),map.addLayer({id:"sup-calles-paved",source:"openmaptiles","source-layer":"transportation",type:"line",minzoom:12,filter:["all",["==","$type","LineString"],["in","class","motorway","trunk","primary","secondary","tertiary","minor","service","track","path","raceway","transit"],["==","surface","paved"]],layout:{"line-cap":"round","line-join":"round",visibility:"visible"},paint:{"line-color":"#d742f5","line-width":{base:1.55,stops:[[4,.25],[20,30]]}}})):(map.removeLayer("sup-calles-paved"),map.removeLayer("sup-calles-unpaved"))})),$("#chk_cruce_andes").click((function(e){1==$(this).is(":checked")?(map.addSource("cruce-andes",{type:"geojson",data:"map/capas/cruce-de-los-andes.geojson"}),map.addLayer({id:"rutas",type:"line",source:"cruce-andes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-width":{stops:[[4,2],[5,3],[12,4]]},"line-color":{property:"ruta",type:"categorical",stops:[["Paso de Come-Caballos","#7983EF"],["Paso de Los Patos","#2196f3"],["Paso del Planchón","#e55e5e"],["Paso de Guana","#3bb2d0"],["Paso del Potrillo","#253494"],["Paso de Uspallata","#fd8d3c"]]}}}),map.addLayer({id:"batallas",type:"circle",source:"cruce-andes",paint:{"circle-radius":6,"circle-color":"red"},filter:["==","$type","Point"]}),map.on("click","rutas",(function(e){var a=e.features[0].properties,t="<b>"+a.ruta+"</b><br><p>Altura máxima: "+a.altitud_maxima+"<br>Efectivos: "+a.efectivos+"<br>Fecha: "+a.fecha_inicio+"</p>";(new mapboxgl.Popup).setLngLat(e.lngLat).setHTML(t).addTo(map)})),map.on("mouseenter","rutas",(function(){map.getCanvas().style.cursor="pointer"})),map.on("mouseleave","rutas",(function(){map.getCanvas().style.cursor=""})),map.fitBounds([[-79.83,-35.68],[-56.27,-26.47]])):(map.removeLayer("rutas"),map.removeLayer("batallas"),map.removeSource("cruce-andes"))})),$("#chk_edificios_3d").click((function(e){1==$(this).is(":checked")?map.addLayer(edificios_3d):map.removeLayer("osmbuildings")})),$("#chk_colectivos").click((function(e){1==$(this).is(":checked")?(map.addLayer(colectivos),map.addLayer(colectivosRef)):(map.removeLayer("colectivos-ref"),map.removeLayer("colectivos"))})),$("#chk_red_vial").click((function(e){1==$(this).is(":checked")?map.addLayer(red_vial):map.removeLayer("red_vial")})),$("#chk_corriente_agua_l").click((function(e){1==$(this).is(":checked")?(map.addLayer(corriente_agua_l),map.addLayer(corriente_agua_l_name)):(map.removeLayer("corriente_agua_l"),map.removeLayer("corriente_agua_l_name"))})),$("#chk_espejo_agua").click((function(e){1==$(this).is(":checked")?(map.addLayer(espejo_agua),map.addLayer(espejo_agua_label)):(map.removeLayer("espejo_agua"),map.removeLayer("espejo_agua_label"))})),$("#chk_municipios").click((function(e){1==$(this).is(":checked")?map.addLayer(municipios):map.removeLayer("municipios")})),$("#btnPanelDatos").click((function(){$("#features").toggleClass(),$("#features").hasClass("oculto")?($("#btnPanelDatos").css("color","white"),$("#btnPanelDatos").css("background","#0074D9"),$("#btnPanelDatos").html("Ver datos de objetos")):($("#btnPanelDatos").css("color","#0074D9"),$("#btnPanelDatos").css("background","#dddddd"),$("#btnPanelDatos").html("Ocultar datos de objetos"))})),map.on("load",(function(){!function(){let e=`<div id="sliderPanel" class="map-overlay-inner"><h2>Eclipse solar 14 de diciembre de 2020</h2><div style="margin: auto; padding: 0; display: table;">\x3c!--<button name="play" type="button"></button>--\x3e<button name="start" title="Inicio" type="button"><i class="fas fa-angle-double-left"></i></button><button name="back" title="Atrás" type="button"><i class="fas fa-angle-left"></i></button><button name="next" title="Adelante" type="button"><i class="fas fa-angle-right"></i></button><button name="end" title="Fin" type="button"><i class="fas fa-angle-double-right"></i></button></div></br><label id="hora"></label><input id="slider" type="range" min="0" max="${horas.length-1}" step="1" value="50" />El ícono de la sombra muestra la ubicación, no su tamaño real</div>`;timeSlider=document.createElement("div"),timeSlider.classList.add("map-overlay"),timeSlider.innerHTML=e,document.body.append(timeSlider)}(),a(),map.addLayer({id:"sky",type:"sky",paint:{"sky-type":"gradient","sky-gradient":["interpolate",["linear"],["sky-radial-progress"],.8,"rgba(135, 206, 235, 1.0)",1,"rgba(0,0,0,0.1)"],"sky-gradient-center":[0,0],"sky-gradient-radius":90,"sky-opacity":["interpolate",["exponential",.1],["zoom"],5,0,22,1]}})})),$("#editarMapa").click((function(e){return e.preventDefault(),function(){var e=Math.round(map.getZoom());if(e>15){var a=map.getCenter().lng,t="https://www.openstreetmap.org/edit#map="+e+"/"+map.getCenter().lat+"/"+a;window.open(t,"_blank")}else alert("Acercar para editar")}(),!1})),map.on("click",(function(e){(t=map.queryRenderedFeatures(e.point)).hasOwnProperty(0)&&(document.getElementById("features").innerHTML=JSON.stringify(t[0].properties,null,2))}))}));